<script lang="ts">
  import EmailFormField from "$lib/components/form/fields/EmailFormField.svelte";
  import FormFieldControl from "$lib/components/form/fields/FormFieldControl.svelte";
  import FormMessage from "$lib/components/form/FormMessage.svelte";
  import SuperformInput from "$lib/components/form/inputs/SuperformInput.svelte";
  import Checkbox from "$lib/components/ui/checkbox/checkbox.svelte";
  import FormButton from "$lib/components/ui/form/form-button.svelte";
  import { AUTH, type IAuth } from "$lib/const/auth.const.js";
  import { AuthSchema } from "$lib/schema/auth.schema";
  import {
    superForm,
    type Infer,
    type SuperValidated,
  } from "sveltekit-superforms";
  import { zod4Client } from "sveltekit-superforms/adapters";

  let {
    form_input,
  }: {
    form_input: SuperValidated<Infer<typeof AuthSchema.signin_form>>;
  } = $props();

  const provider_id = "credential" satisfies IAuth.ProviderId;
  const provider = AUTH.PROVIDERS.MAP[provider_id];

  const form = superForm(form_input, {
    delayMs: 500,
    timeoutMs: 8_000,
    validators: zod4Client(AuthSchema.signin_form),

    onResult: ({ result }) => {
      if (result.type === "redirect") {
        location.href = result.location;
      }
    },
  });

  const { form: form_data } = form;
</script>

<form class="space-y-4" method="POST" use:form.enhance>
  <EmailFormField {form} bind:value={$form_data.email} />

  <FormFieldControl {form} name="password" label="Password">
    {#snippet children({ props })}
      <SuperformInput
        {...props}
        {form}
        type="password"
        placeholder="Your password"
        autocomplete="current-password"
      />
    {/snippet}
  </FormFieldControl>

  <FormFieldControl {form} name="remember" horizontal label="Remember me">
    {#snippet children({ props })}
      <Checkbox {...props} bind:checked={$form_data.remember} />
    {/snippet}
  </FormFieldControl>

  <FormButton {form} class="w-full" icon={provider.icon}>
    Signin with {provider.name}
  </FormButton>

  <FormMessage {form} />
</form>
